# Экспорт CSV с ссылками гостей

## Описание

Новая функциональность позволяет экспортировать список всех приглашенных гостей в формате CSV с дополнительной колонкой "Ссылка гостя". Эта функция доступна в интерфейсе просмотра приглашений (`view_invitation`) и реализована в `combined_app.py`.

## Функциональность

### Что экспортируется

CSV файл содержит следующие колонки:

1. **Сторона** - сторона гостя (по умолчанию "Гость")
2. **Имя гостя** - никнейм гостя (если указан)
3. **Имя Гостя в приглашении** - полное имя гостя
4. **Ссылка гостя** - уникальная ссылка для доступа к приглашению

### Поддерживаемые языки

- **Русский** (`ru`) - заголовки на русском языке
- **Армянский** (`hy`) - заголовки на армянском языке

## Использование

### В веб-интерфейсе

1. Перейдите на страницу просмотра приглашений (`/view_invitation?event_id=X`)
2. Найдите кнопку **"Экспорт CSV с ссылками"** (желтая кнопка с иконкой CSV)
3. Нажмите на кнопку
4. Файл автоматически скачается с именем вида `гости_со_ссылками_{event_id}_{date}.csv`

### API Endpoint

```
POST /api/export_csv_guests_with_links
```

#### Параметры запроса (JSON)

```json
{
    "event_id": 123,
    "language": "ru"
}
```

#### Ответ

```json
{
    "success": true,
    "csv_data": "Сторона,Имя гостя,Имя Гостя в приглашении,Ссылка гостя\nГость,Мама,Анаит Ервандовна,http://localhost:5000/invite?h=Anai7x2k629",
    "filename": "guests_with_links_123.csv",
    "total_guests": 25
}
```

## Пример CSV файла

```csv
Сторона,Имя гостя,Имя Гостя в приглашении,Ссылка гостя
Гость,Мама,Анаит Ервандовна,http://localhost:5000/invite?h=Anai7x2k629
Гость,Папа,Ерванд Арамаисович,http://localhost:5000/invite?h=Erva9m4p629
Гость,Бабушка,Людмила Петровна,http://localhost:5000/invite?h=Lyud5n8q629
```

## Тестирование

Для тестирования функции используйте скрипт `test_csv_export.py`:

```bash
python test_csv_export.py
```

Скрипт проверит:
- Экспорт на русском языке
- Экспорт на армянском языке
- Корректность структуры CSV
- Генерацию ссылок
- Обработку ошибок

## Технические детали

### Генерация ссылок

Ссылки гостей генерируются по формуле:
```
{base_url}/invite?h={invitation_hash}
```

Где:
- `base_url` - базовый URL приложения
- `invitation_hash` - уникальный хеш приглашения из базы данных

### Безопасность

- Функция защищена декоратором `@require_event_access`
- Требуется аутентификация пользователя
- Проверяется доступ к событию

### Обработка ошибок

- Проверка существования события
- Проверка наличия приглашений
- Валидация параметров запроса
- Обработка ошибок базы данных

## Изменения в коде

### Добавленные файлы

1. **combined_app.py** - новая функция `export_csv_guests_with_links` (строки 350-420)
2. **templates/view_invitations.html** - кнопка экспорта и JavaScript обработчик
3. **test_csv_export.py** - тестовый скрипт
4. **README_csv_export.md** - документация

### Модифицированные файлы

1. **templates/view_invitations.html**:
   - Добавлена кнопка экспорта CSV
   - Добавлены переводы на армянский и русский
   - Добавлен JavaScript обработчик

## Запуск приложения

Для запуска используйте `combined_app.py`:

```bash
python combined_app.py
```

Приложение будет доступно по адресу `http://localhost:5000`

## Требования

- Python 3.6+
- Flask
- psycopg2 (для работы с PostgreSQL)
- requests (для тестирования)

## Устранение неполадок

### Ошибка "Event ID is required"
- Убедитесь, что передается корректный `event_id`

### Ошибка "No invitations found"
- Проверьте, что для события есть приглашения в базе данных

### Ошибка аутентификации
- Убедитесь, что пользователь авторизован
- Проверьте права доступа к событию

### Проблемы с кодировкой
- CSV файл генерируется в UTF-8
- Убедитесь, что ваш редактор поддерживает UTF-8

### Проблемы с подключением к серверу
- Убедитесь, что `combined_app.py` запущен
- Проверьте, что порт 5000 свободен
- Проверьте логи приложения на наличие ошибок
